<!DOCTYPE html>
<html lang="is">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Registration - Sleipnir MC</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .test-container {
            max-width: 600px;
            margin: 100px auto;
            padding: 20px;
            background: var(--norse-black);
            border: 1px solid var(--mc-red);
        }
        .test-form input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            background: var(--midnight-black);
            border: 1px solid #333;
            color: white;
        }
        .test-button {
            width: 100%;
            padding: 15px;
            background: var(--mc-red);
            color: white;
            border: none;
            cursor: pointer;
            font-size: 1.1rem;
            margin-top: 20px;
        }
        .test-button:hover {
            background: var(--mc-red-hover);
        }
        .test-button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        .message {
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }
        .error {
            background: rgba(255, 0, 0, 0.2);
            border: 1px solid red;
            color: #ff6666;
        }
        .success {
            background: rgba(0, 255, 0, 0.2);
            border: 1px solid green;
            color: #66ff66;
        }
        .info {
            background: rgba(0, 100, 255, 0.2);
            border: 1px solid #0066ff;
            color: #66aaff;
        }
        #console {
            background: #000;
            border: 1px solid #333;
            padding: 10px;
            margin-top: 20px;
            font-family: monospace;
            font-size: 0.9rem;
            max-height: 300px;
            overflow-y: auto;
        }
        .log-entry {
            margin: 2px 0;
        }
        .log-error { color: #ff6666; }
        .log-success { color: #66ff66; }
        .log-info { color: #66aaff; }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>Simple Registration Test</h1>
        <p>This is a minimal test to identify registration issues.</p>
        
        <div id="messages"></div>
        
        <form id="testForm" class="test-form">
            <input type="email" id="email" placeholder="Email" required>
            <input type="password" id="password" placeholder="Password (min 6 chars)" required>
            <input type="text" id="fullName" placeholder="Full Name" required>
            <button type="submit" id="submitBtn" class="test-button">Create Account</button>
        </form>
        
        <div id="console">
            <div class="log-entry log-info">Console initialized...</div>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="javascript/firebase-config.js"></script>
    
    <script>
        // Simple console logger
        const logConsole = document.getElementById('console');
        function log(message, type = 'info') {
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logConsole.appendChild(entry);
            logConsole.scrollTop = logConsole.scrollHeight;
            console.log(message);
        }

        function showMessage(message, type = 'info') {
            const messagesDiv = document.getElementById('messages');
            messagesDiv.innerHTML = `<div class="message ${type}">${message}</div>`;
        }

        // Test form handler
        document.getElementById('testForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const fullName = document.getElementById('fullName').value;
            const submitBtn = document.getElementById('submitBtn');
            
            log('Starting registration process...', 'info');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Creating account...';
            
            try {
                // Step 1: Create auth account
                log('Step 1: Creating Firebase Auth account...', 'info');
                const userCredential = await firebase.auth().createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                log(`Auth account created successfully. UID: ${user.uid}`, 'success');
                
                // Step 2: Create Firestore profile
                log('Step 2: Creating Firestore profile...', 'info');
                await firebase.firestore().collection('users').doc(user.uid).set({
                    fullName: fullName,
                    email: email,
                    role: 'customer',
                    emailVerified: false,
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    // Minimal data for testing
                    address: 'Test Address',
                    city: 'Reykjavik',
                    postalCode: '101'
                });
                log('Firestore profile created successfully', 'success');
                
                // Step 3: Send verification email
                log('Step 3: Sending verification email...', 'info');
                submitBtn.textContent = 'Sending verification email...';
                
                try {
                    // Simple direct call
                    await user.sendEmailVerification();
                    log('Verification email sent successfully', 'success');
                    
                    showMessage('Account created! Check your email for verification.', 'success');
                    
                    // Reset form
                    document.getElementById('testForm').reset();
                    
                } catch (emailError) {
                    log(`Email error: ${emailError.code} - ${emailError.message}`, 'error');
                    showMessage(`Account created but email failed: ${emailError.message}`, 'error');
                }
                
            } catch (error) {
                log(`Error: ${error.code} - ${error.message}`, 'error');
                
                // Specific error handling
                if (error.code === 'auth/email-already-in-use') {
                    showMessage('This email is already registered', 'error');
                } else if (error.code === 'auth/weak-password') {
                    showMessage('Password is too weak (min 6 characters)', 'error');
                } else if (error.code === 'auth/invalid-email') {
                    showMessage('Invalid email address', 'error');
                } else if (error.code === 'auth/network-request-failed') {
                    showMessage('Network error - check your connection', 'error');
                } else if (error.code === 'auth/too-many-requests') {
                    showMessage('Too many attempts. Please wait and try again.', 'error');
                    log('Rate limit hit - this might be Firebase\'s built-in protection', 'error');
                } else {
                    showMessage(`Error: ${error.message}`, 'error');
                }
                
                // Log full error details
                log(`Full error object: ${JSON.stringify(error, null, 2)}`, 'error');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Create Account';
            }
        });

        // Check current auth state
        firebase.auth().onAuthStateChanged((user) => {
            if (user) {
                log(`Currently signed in as: ${user.email}`, 'info');
                log(`Email verified: ${user.emailVerified}`, 'info');
            } else {
                log('No user currently signed in', 'info');
            }
        });

        // Test Firebase connection
        log('Testing Firebase connection...', 'info');
        firebase.firestore().collection('_test').doc('ping').set({
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        }).then(() => {
            log('Firebase connection successful', 'success');
        }).catch((error) => {
            log(`Firebase connection error: ${error.message}`, 'error');
        });
    </script>
</body>
</html>