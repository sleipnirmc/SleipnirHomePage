<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Auth Diagnostics - Sleipnir MC</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .diag-container {
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
            background: var(--norse-black);
            border: 1px solid var(--mc-red);
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            background: var(--midnight-black);
            border: 1px solid #333;
        }
        .test-button {
            padding: 10px 20px;
            background: var(--mc-red);
            color: white;
            border: none;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: var(--mc-red-hover);
        }
        .test-button:disabled {
            background: #666;
            cursor: not-allowed;
        }
        .result {
            margin: 10px 0;
            padding: 10px;
            background: #111;
            border: 1px solid #333;
            font-family: monospace;
            white-space: pre-wrap;
            word-wrap: break-word;
        }
        .result.success { border-color: green; color: #0f0; }
        .result.error { border-color: red; color: #f66; }
        .result.warning { border-color: orange; color: #fa0; }
        .result.info { border-color: #06f; color: #6af; }
    </style>
</head>
<body>
    <div class="diag-container">
        <h1>Firebase Auth Diagnostics</h1>
        <p>Use this page to diagnose authentication issues.</p>

        <div class="test-section">
            <h2>1. Firebase Connection Test</h2>
            <button class="test-button" onclick="testFirebaseConnection()">Test Connection</button>
            <div id="connectionResult" class="result"></div>
        </div>

        <div class="test-section">
            <h2>2. Auth State Check</h2>
            <button class="test-button" onclick="checkAuthState()">Check Auth State</button>
            <div id="authStateResult" class="result"></div>
        </div>

        <div class="test-section">
            <h2>3. Create Test Account</h2>
            <input type="email" id="testEmail" placeholder="test@example.com" style="padding: 10px; margin: 5px;">
            <input type="password" id="testPassword" placeholder="password123" style="padding: 10px; margin: 5px;">
            <button class="test-button" onclick="createTestAccount()">Create Account</button>
            <div id="createAccountResult" class="result"></div>
        </div>

        <div class="test-section">
            <h2>4. Network Diagnostics</h2>
            <button class="test-button" onclick="runNetworkDiagnostics()">Run Network Tests</button>
            <div id="networkResult" class="result"></div>
        </div>

        <div class="test-section">
            <h2>5. Firebase Auth Methods</h2>
            <button class="test-button" onclick="checkAuthMethods()">Check Available Methods</button>
            <div id="authMethodsResult" class="result"></div>
        </div>

        <div class="test-section">
            <h2>6. Rate Limit Test</h2>
            <button class="test-button" onclick="testRateLimit()">Test Rate Limits</button>
            <div id="rateLimitResult" class="result"></div>
        </div>

        <div class="test-section">
            <h2>7. Clear All Auth Data</h2>
            <button class="test-button" onclick="clearAuthData()" style="background: #a00;">Clear Local Auth Data</button>
            <div id="clearDataResult" class="result"></div>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="javascript/firebase-config.js"></script>

    <script>
        function showResult(elementId, message, type = 'info') {
            const element = document.getElementById(elementId);
            element.className = `result ${type}`;
            element.textContent = message;
        }

        async function testFirebaseConnection() {
            showResult('connectionResult', 'Testing Firebase connection...', 'info');
            
            try {
                // Test Firestore
                const testDoc = await firebase.firestore().collection('_test').add({
                    timestamp: firebase.firestore.FieldValue.serverTimestamp(),
                    test: true
                });
                
                // Clean up
                await testDoc.delete();
                
                showResult('connectionResult', 
                    `✓ Firebase connection successful
✓ Firestore is accessible
✓ Project ID: ${firebase.app().options.projectId}
✓ Auth Domain: ${firebase.app().options.authDomain}`, 'success');
            } catch (error) {
                showResult('connectionResult', 
                    `✗ Firebase connection failed
Error: ${error.code}
Message: ${error.message}`, 'error');
            }
        }

        function checkAuthState() {
            const user = firebase.auth().currentUser;
            
            if (user) {
                showResult('authStateResult', 
                    `✓ User is signed in
Email: ${user.email}
UID: ${user.uid}
Email Verified: ${user.emailVerified}
Creation Time: ${user.metadata.creationTime}
Last Sign In: ${user.metadata.lastSignInTime}`, 'success');
            } else {
                showResult('authStateResult', '✗ No user is currently signed in', 'warning');
            }
        }

        async function createTestAccount() {
            const email = document.getElementById('testEmail').value;
            const password = document.getElementById('testPassword').value;
            
            if (!email || !password) {
                showResult('createAccountResult', 'Please enter email and password', 'error');
                return;
            }
            
            showResult('createAccountResult', 'Creating test account...', 'info');
            
            try {
                // First, sign out any existing user
                await firebase.auth().signOut();
                
                // Create account
                const userCredential = await firebase.auth().createUserWithEmailAndPassword(email, password);
                const user = userCredential.user;
                
                let result = `✓ Account created successfully
UID: ${user.uid}
Email: ${user.email}

Testing email verification...`;
                showResult('createAccountResult', result, 'info');
                
                // Try to send verification email
                try {
                    await user.sendEmailVerification();
                    result += '\n✓ Verification email sent successfully';
                    showResult('createAccountResult', result, 'success');
                } catch (emailError) {
                    result += `\n✗ Email verification failed
Error: ${emailError.code}
Message: ${emailError.message}`;
                    showResult('createAccountResult', result, 'warning');
                }
                
            } catch (error) {
                let errorInfo = `✗ Account creation failed
Error Code: ${error.code}
Message: ${error.message}`;
                
                // Add specific error details
                if (error.code === 'auth/email-already-in-use') {
                    errorInfo += '\n\nThis email is already registered.';
                } else if (error.code === 'auth/too-many-requests') {
                    errorInfo += '\n\n⚠️ RATE LIMIT DETECTED';
                    errorInfo += '\nFirebase is blocking requests from this device/IP.';
                    errorInfo += '\nThis is Firebase\'s built-in protection.';
                    errorInfo += '\nWait a few minutes before trying again.';
                }
                
                showResult('createAccountResult', errorInfo, 'error');
            }
        }

        async function runNetworkDiagnostics() {
            showResult('networkResult', 'Running network diagnostics...', 'info');
            
            let results = [];
            
            // Test 1: Basic fetch
            try {
                const response = await fetch('https://www.google.com/favicon.ico');
                results.push('✓ Basic internet connectivity: OK');
            } catch (error) {
                results.push('✗ Basic internet connectivity: FAILED');
            }
            
            // Test 2: Firebase Auth endpoint
            try {
                const response = await fetch('https://identitytoolkit.googleapis.com/v1/accounts:lookup?key=' + firebase.app().options.apiKey, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ idToken: 'test' })
                });
                results.push(`✓ Firebase Auth API accessible: ${response.status}`);
            } catch (error) {
                results.push('✗ Firebase Auth API: ' + error.message);
            }
            
            // Test 3: Check localStorage
            try {
                localStorage.setItem('test', 'test');
                localStorage.removeItem('test');
                results.push('✓ localStorage: Available');
            } catch (error) {
                results.push('✗ localStorage: Not available');
            }
            
            // Test 4: Check IndexedDB
            try {
                const request = indexedDB.open('test');
                request.onsuccess = () => {
                    indexedDB.deleteDatabase('test');
                    results.push('✓ IndexedDB: Available');
                    showResult('networkResult', results.join('\n'), 'success');
                };
                request.onerror = () => {
                    results.push('✗ IndexedDB: Not available');
                    showResult('networkResult', results.join('\n'), 'warning');
                };
            } catch (error) {
                results.push('✗ IndexedDB: Error');
                showResult('networkResult', results.join('\n'), 'warning');
            }
        }

        async function checkAuthMethods() {
            showResult('authMethodsResult', 'Checking auth methods...', 'info');
            
            try {
                const provider = firebase.auth();
                let methods = [];
                
                // Check enabled sign-in methods
                methods.push('Checking available auth providers...');
                
                // These would normally be configured in Firebase Console
                methods.push('\nConfigured providers (check Firebase Console):');
                methods.push('- Email/Password');
                methods.push('- Phone (if enabled)');
                methods.push('- Google (if enabled)');
                methods.push('- Facebook (if enabled)');
                
                // Check persistence
                methods.push('\nCurrent persistence: ' + firebase.auth().persistenceState);
                
                showResult('authMethodsResult', methods.join('\n'), 'info');
            } catch (error) {
                showResult('authMethodsResult', 'Error checking methods: ' + error.message, 'error');
            }
        }

        async function testRateLimit() {
            showResult('rateLimitResult', 'Testing rate limits...', 'info');
            
            let results = [];
            const testEmail = `ratelimit-test-${Date.now()}@test.com`;
            
            try {
                // Test multiple quick requests
                for (let i = 0; i < 5; i++) {
                    try {
                        const methods = await firebase.auth().fetchSignInMethodsForEmail(testEmail);
                        results.push(`✓ Request ${i + 1}: Success`);
                    } catch (error) {
                        results.push(`✗ Request ${i + 1}: ${error.code}`);
                        if (error.code === 'auth/too-many-requests') {
                            results.push('\n⚠️ RATE LIMIT HIT');
                            results.push('Firebase is rate limiting this device/IP');
                            break;
                        }
                    }
                    
                    // Small delay between requests
                    await new Promise(resolve => setTimeout(resolve, 100));
                }
                
                showResult('rateLimitResult', results.join('\n'), 
                    results.some(r => r.includes('✗')) ? 'warning' : 'success');
                
            } catch (error) {
                showResult('rateLimitResult', 'Test failed: ' + error.message, 'error');
            }
        }

        async function clearAuthData() {
            try {
                // Sign out
                await firebase.auth().signOut();
                
                // Clear localStorage
                const keysToRemove = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && (key.includes('firebase') || key.includes('auth'))) {
                        keysToRemove.push(key);
                    }
                }
                keysToRemove.forEach(key => localStorage.removeItem(key));
                
                // Clear sessionStorage
                sessionStorage.clear();
                
                // Clear IndexedDB (Firebase Auth data)
                const databases = await indexedDB.databases();
                for (const db of databases) {
                    if (db.name && db.name.includes('firebase')) {
                        indexedDB.deleteDatabase(db.name);
                    }
                }
                
                showResult('clearDataResult', 
                    `✓ Signed out successfully
✓ Cleared ${keysToRemove.length} localStorage items
✓ Cleared sessionStorage
✓ Cleared IndexedDB Firebase data

You may want to refresh the page now.`, 'success');
                
            } catch (error) {
                showResult('clearDataResult', 'Error clearing data: ' + error.message, 'error');
            }
        }

        // Auto-run connection test on load
        window.addEventListener('load', () => {
            testFirebaseConnection();
            checkAuthState();
        });
    </script>
</body>
</html>