<!DOCTYPE html>
<html lang="is">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sleipnir MC - Admin</title>
    <link rel="stylesheet" href="styles.css">
    <script src="javascript/member-card-templates.js"></script>
    <style>
        /* Admin Layout */
        .admin-container {
            max-width: 1400px;
            margin: 100px auto 40px;
            padding: 20px;
        }

        /* Admin Header */
        .admin-header {
            background: var(--norse-black);
            border: 1px solid var(--mc-red);
            padding: 30px;
            margin-bottom: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .admin-title {
            font-family: 'Iceland', 'Cinzel', serif;
            font-size: 2.5rem;
            color: var(--white);
        }

        /* Options Dropdown */
        .admin-options {
            position: relative;
        }

        .options-btn {
            padding: 12px 30px;
            background: var(--mc-red);
            color: white;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .options-btn:hover {
            background: var(--mc-red-hover);
            transform: translateY(-2px);
        }

        .options-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 10px;
            background: var(--norse-black);
            border: 1px solid var(--mc-red);
            min-width: 250px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(-10px);
            transition: all 0.3s;
            z-index: 1000;
        }

        .admin-options.active .options-dropdown {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .options-dropdown a {
            display: block;
            padding: 15px 20px;
            color: var(--white);
            text-decoration: none;
            transition: all 0.3s;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .options-dropdown a:last-child {
            border-bottom: none;
        }

        .options-dropdown a:hover {
            background: rgba(255,0,0,0.2);
            color: var(--mc-red);
            padding-left: 25px;
        }

        /* Dashboard Stats */
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--norse-black);
            border: 1px solid rgba(207, 35, 66, 0.3);
            padding: 25px;
            text-align: center;
            transition: all 0.3s;
        }

        .stat-card:hover {
            border-color: var(--mc-red);
            transform: translateY(-2px);
        }

        .stat-number {
            font-size: 3rem;
            color: var(--mc-red);
            font-weight: bold;
            margin-bottom: 10px;
        }

        .stat-label {
            color: var(--gray);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Admin Sections */
        .admin-section {
            background: rgba(26,26,26,0.9);
            border: 1px solid var(--mc-red);
            padding: 30px;
            margin-bottom: 30px;
            display: none;
        }

        .admin-section.active {
            display: block;
        }

        .section-header {
            border-bottom: 2px solid var(--mc-red);
            padding-bottom: 15px;
            margin-bottom: 25px;
        }

        .section-title {
            font-size: 1.8rem;
            color: var(--white);
            margin-bottom: 5px;
        }

        /* Forms */
        .admin-form {
            display: grid;
            gap: 15px;
            max-width: 600px;
        }

        .form-group {
            display: grid;
            gap: 5px;
        }

        .admin-input, .admin-textarea, .admin-select {
            width: 100%;
            padding: 12px;
            background: rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.2);
            color: white;
            font-size: 1rem;
            transition: all 0.3s;
        }

        .admin-input:focus, .admin-textarea:focus, .admin-select:focus {
            outline: none;
            border-color: var(--mc-red);
            background: rgba(0,0,0,0.7);
        }

        .admin-textarea {
            resize: vertical;
            min-height: 100px;
        }

        /* Buttons */
        .admin-btn {
            padding: 12px 25px;
            background: var(--mc-red);
            color: white;
            border: none;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
            transition: all 0.3s;
        }

        .admin-btn:hover {
            background: var(--mc-red-hover);
            transform: translateY(-2px);
        }

        .admin-btn.secondary {
            background: var(--charcoal);
        }

        .admin-btn.edit {
            background: var(--crimson);
        }

        .admin-btn.delete {
            background: var(--dark-red);
        }

        /* Grid Layouts */
        .admin-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .admin-card {
            background: rgba(10,10,10,0.8);
            border: 1px solid rgba(255,0,0,0.2);
            padding: 20px;
            position: relative;
            transition: all 0.3s;
        }

        .admin-card:hover {
            border-color: var(--mc-red);
            transform: translateY(-2px);
        }

        .admin-card img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            margin-bottom: 15px;
            border-radius: 4px;
        }

        /* Orders Table */
        .orders-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        .orders-table th,
        .orders-table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .orders-table th {
            background: rgba(207, 35, 66, 0.2);
            color: var(--white);
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .orders-table tr:hover {
            background: rgba(255,255,255,0.05);
        }

        .order-status {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }

        .order-status.pending {
            background: rgba(255, 165, 0, 0.2);
            color: orange;
        }

        .order-status.completed {
            background: rgba(0, 255, 0, 0.2);
            color: #00ff00;
        }

        /* Tabs */
        .admin-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .tab-btn {
            padding: 10px 20px;
            background: transparent;
            color: var(--gray);
            border: none;
            cursor: pointer;
            font-size: 1rem;
            transition: all 0.3s;
            position: relative;
        }

        .tab-btn.active {
            color: var(--white);
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            right: 0;
            height: 2px;
            background: var(--mc-red);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Mode Toggle Switch */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .mode-toggle {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #4CAF50;
            transition: .4s;
            border-radius: 30px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: #f44336;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(30px);
        }

        .mode-label {
            font-weight: 600;
            color: var(--white);
            text-transform: uppercase;
            letter-spacing: 1px;
            font-size: 0.9rem;
        }

        /* File Upload */
        .drop-zone {
            border: 2px dashed var(--mc-red);
            border-radius: 5px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            cursor: pointer;
            transition: all 0.3s;
            background: rgba(255,0,0,0.05);
        }

        .drop-zone:hover {
            background: rgba(255,0,0,0.1);
            border-color: var(--white);
        }

        .drop-zone.dragover {
            background: rgba(255,0,0,0.2);
            transform: scale(1.02);
        }

        /* Member Card */
        .member-card {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 20px;
            background: rgba(26,26,26,0.9);
            border: 1px solid rgba(207, 35, 66, 0.3);
            margin-bottom: 15px;
            transition: all 0.3s;
            border-radius: 5px;
        }

        .member-card:hover {
            border-color: var(--mc-red);
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(207, 35, 66, 0.2);
        }

        .member-photo-small {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            object-fit: cover;
        }

        .member-info {
            flex: 1;
        }

        .member-actions {
            display: flex;
            gap: 10px;
        }

        /* Template Preview Modal */
        .template-preview-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .template-preview-modal.active {
            display: flex;
        }

        .template-preview-content {
            background: var(--norse-black);
            border: 2px solid var(--mc-red);
            padding: 30px;
            max-width: 1200px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .template-preview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--mc-red);
            padding-bottom: 20px;
        }

        .template-preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .template-option {
            border: 2px solid transparent;
            padding: 20px;
            background: rgba(26,26,26,0.5);
            cursor: pointer;
            transition: all 0.3s;
        }

        .template-option:hover {
            border-color: var(--mc-red);
            transform: translateY(-5px);
        }

        .template-option.selected {
            border-color: var(--mc-red);
            background: rgba(207, 35, 66, 0.1);
        }

        .template-name {
            font-family: 'Cinzel', serif;
            font-size: 1.2rem;
            color: var(--white);
            margin-bottom: 15px;
            text-align: center;
            text-transform: uppercase;
        }

        .close-modal {
            position: absolute;
            top: 20px;
            right: 20px;
            font-size: 2rem;
            color: var(--white);
            cursor: pointer;
            transition: color 0.3s;
        }

        .close-modal:hover {
            color: var(--mc-red);
        }

        /* Size checkboxes */
        .size-checkbox {
            display: inline-flex;
            align-items: center;
            gap: 5px;
            padding: 5px 10px;
            background: rgba(0,0,0,0.5);
            border: 1px solid rgba(255,255,255,0.2);
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .size-checkbox:hover {
            border-color: var(--mc-red);
        }

        .size-checkbox input[type="checkbox"] {
            cursor: pointer;
        }

        /* Loading overlay */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
        }

        .loading-spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top: 3px solid var(--mc-red);
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* User Deletion Checkbox Styles */
        .delete-user-checkbox {
            width: 20px;
            height: 20px;
            cursor: pointer;
            accent-color: var(--mc-red);
        }
        
        .delete-checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .delete-checkbox-label {
            color: var(--mc-red);
            font-size: 14px;
            cursor: pointer;
        }
        
        /* Email Confirmation Modal */
        .email-confirm-modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(255, 255, 255, 0.1) ;
            padding: 30px;
            border-radius: 5px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
            z-index: 1001;
            max-width: 500px;
            width: 90%;
        }
        
        .email-confirm-modal h3 {
            color: var(--mc-red);
            margin-bottom: 20px;
        }
        
        .email-confirm-modal input {
            width: 100%;
            padding: 10px;
            margin: 10px 0;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--white);
            border-radius: 5px;
        }
        
        .email-confirm-modal .warning-text {
            color: #FF9800;
            font-size: 14px;
            margin: 15px 0;
            line-height: 1.5;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .admin-header {
                flex-direction: column;
                gap: 20px;
                text-align: center;
            }

            .admin-grid {
                grid-template-columns: 1fr;
            }

            .dashboard-stats {
                grid-template-columns: 1fr;
            }

            .bulk-actions-bar {
                flex-direction: column;
                gap: 10px;
            }
        }
    </style>
</head>
<body style="display: none;">
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
    </div>

    <!-- Header -->
    <header>
        <nav>
            <div class="logo">
                <a href="index.html" class="logo-link">
                    <span class="logo-text">SLEIPNIR MC</span>
                    <span class="location">ADMIN</span>
                </a>
            </div>
            <ul class="nav-links">
                <li><a href="index.html"><span class="is">Heim</span><span class="en">Home</span></a></li>
                <li><a href="shop.html"><span class="is">Verslun</span><span class="en">Shop</span></a></li>
                <li><a href="about.html"><span class="is">H√≥purinn</span><span class="en">Members</span></a></li>
                <li><a href="contact.html"><span class="is">Hafa Samband</span><span class="en">Contact</span></a></li>
                <li><a href="admin.html" class="active"><span class="is">ADMIN</span><span class="en">ADMIN</span></a></li>
            </ul>
            <div class="user-menu" style="display: none;">
                <span class="user-name"></span>
                <button class="btn btn-dark btn-sm" onclick="sleipnirAuth.adminSignOut().then(() => window.location.href = 'index.html')">
                    <span class="is">√ötskr√°</span>
                    <span class="en">Logout</span>
                </button>
            </div>
            <div class="language-toggle">
                <button class="btn btn-dark btn-sm" onclick="toggleLanguage()">
                    <span class="is">EN</span>
                    <span class="en">IS</span>
                </button>
            </div>
        </nav>
    </header>

    <!-- Admin Container -->
    <div class="admin-container">
        <!-- Admin Header -->
        <div class="admin-header">
            <h1 class="admin-title">Admin Dashboard</h1>
            <div class="admin-options" id="adminOptions">
                <button class="options-btn" onclick="toggleOptions()">
                    Options ‚ñº
                </button>
                <div class="options-dropdown">
                    <a href="#" onclick="showSection('members')">View Members</a>
                    <a href="#" onclick="showSection('users')">View Users</a>
                    <a href="#" onclick="showSection('products')">Manage Products</a>
                    <a href="#" onclick="showSection('events')">Manage Events</a>
                    <a href="#" onclick="showSection('orders')">View Orders</a>
                    <a href="#" onclick="showSection('export')">Export Data</a>
                </div>
            </div>
        </div>

        <!-- Dashboard Stats -->
        <div class="dashboard-stats" id="dashboardStats">
            <div class="stat-card">
                <div class="stat-number" id="totalMembers">0</div>
                <div class="stat-label">Total Members</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalUsers">0</div>
                <div class="stat-label">Registered Users</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalOrders">0</div>
                <div class="stat-label">Total Orders</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="pendingOrders">0</div>
                <div class="stat-label">Pending Orders</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalProducts">0</div>
                <div class="stat-label">Products</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalEvents">0</div>
                <div class="stat-label">Events</div>
            </div>
        </div>

        <!-- Members Section -->
        <div class="admin-section" id="membersSection">
            <div class="section-header">
                <h2 class="section-title">Club Members</h2>
            </div>

            <div style="margin-bottom: 20px;">
                <input type="text" class="admin-input" placeholder="Search members..." id="memberSearch" style="max-width: 400px;">
            </div>

            <div id="membersContainer" style="display: grid; gap: 20px;">
                <!-- Members will be loaded here -->
            </div>
        </div>

        <!-- Users Section -->
        <div class="admin-section" id="usersSection">
            <div class="section-header">
                <h2 class="section-title">Registered Users</h2>
                <div class="mode-toggle">
                    <label class="toggle-switch">
                        <input type="checkbox" id="userManagementMode" onchange="toggleUserManagementMode()">
                        <span class="toggle-slider"></span>
                    </label>
                    <span id="modeLabel" class="mode-label">Member Management Mode</span>
                </div>
            </div>

            <div style="margin-bottom: 20px;">
                <input type="text" class="admin-input" placeholder="Search users..." id="userSearch" style="max-width: 400px;">
                <select class="admin-select" id="userFilter" style="max-width: 200px; margin-left: 10px;">
                    <option value="all">All Users</option>
                    <option value="members">Members Only</option>
                    <option value="non-members">Non-Members</option>
                </select>
                <button class="admin-btn secondary" onclick="showBulkMemberModal()" style="margin-left: 10px;">
                    Bulk Member Management
                </button>
                <button class="admin-btn secondary" onclick="syncRealMembers()" style="margin-left: 10px;">
                    Sync Real Members
                </button>
            </div>

            <table class="orders-table">
                <thead>
                    <tr>
                        <th>User ID</th>
                        <th>Name</th>
                        <th>Email</th>
                        <th>Registration Date</th>
                        <th>Member Status</th>
                        <th>Last Login</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody id="usersTableBody">
                    <!-- Users will be loaded here -->
                </tbody>
            </table>
        </div>

        <!-- Products Section -->
        <div class="admin-section" id="productsSection">
            <div class="section-header">
                <h2 class="section-title">Manage Products</h2>
            </div>

            <div class="admin-tabs">
                <button class="tab-btn active" onclick="switchTab('addProduct')">Add Product</button>
                <button class="tab-btn" onclick="switchTab('viewProducts')">View Products</button>
            </div>

            <!-- Add Product Tab -->
            <div class="tab-content active" id="addProductTab">
                <form class="admin-form" id="addProductForm">
                    <div class="form-group">
                        <label>Product Name (Icelandic)</label>
                        <input type="text" class="admin-input" id="productNameIs" required>
                    </div>
                    <div class="form-group">
                        <label>Product Name (English)</label>
                        <input type="text" class="admin-input" id="productNameEn" required>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea class="admin-textarea" id="productDescription" required></textarea>
                    </div>
                    <div class="form-group">
                        <label>Category</label>
                        <select class="admin-select" id="productCategory" required>
                            <option value="">Select Category</option>
                            <option value="tshirt">T-Shirt</option>
                            <option value="hoodie">Hoodie</option>
                            <option value="jacket">Jacket</option>
                            <option value="jeans">Jeans</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Price (ISK)</label>
                        <input type="number" class="admin-input" id="productPrice" required>
                    </div>
                    <div class="form-group">
                        <label>Available Sizes</label>
                        <div id="sizesContainer" style="display: flex; gap: 10px; flex-wrap: wrap;"></div>
                    </div>
                    <div class="form-group">
                        <label>Members Only</label>
                        <select class="admin-select" id="productMembersOnly">
                            <option value="false">No</option>
                            <option value="true">Yes</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Product Images</label>
                        <div class="drop-zone" id="productDropZone">
                            <p>Drag & drop images here or click to upload</p>
                            <input type="file" id="productImages" multiple accept="image/*" style="display: none;">
                        </div>
                        <div id="imagePreview" style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px;"></div>
                    </div>
                    <button type="submit" class="admin-btn">Add Product</button>
                </form>
            </div>

            <!-- View Products Tab -->
            <div class="tab-content" id="viewProductsTab">
                <div class="admin-grid" id="productsGrid">
                    <!-- Products will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Events Section -->
        <div class="admin-section" id="eventsSection">
            <div class="section-header">
                <h2 class="section-title">Manage Events</h2>
            </div>

            <div class="admin-tabs">
                <button class="tab-btn active" onclick="switchEventTab('addEvent')">Add Event</button>
                <button class="tab-btn" onclick="switchEventTab('viewEvents')">View Events</button>
            </div>

            <!-- Add Event Tab -->
            <div class="tab-content active" id="addEventTab">
                <form class="admin-form" id="addEventForm">
                    <div class="form-group">
                        <label>Event Name (Icelandic)</label>
                        <input type="text" class="admin-input" id="eventNameIs" required>
                    </div>
                    <div class="form-group">
                        <label>Event Name (English)</label>
                        <input type="text" class="admin-input" id="eventNameEn" required>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea class="admin-textarea" id="eventDescription" required></textarea>
                    </div>
                    <div class="form-group">
                        <label>Date & Time</label>
                        <input type="datetime-local" class="admin-input" id="eventDate" required>
                    </div>
                    <div class="form-group">
                        <label>Location</label>
                        <input type="text" class="admin-input" id="eventLocation" required>
                    </div>
                    <div class="form-group">
                        <label>Event Type</label>
                        <select class="admin-select" id="eventCategory" required>
                            <option value="">Select Type</option>
                            <option value="ride">Ride</option>
                            <option value="meeting">Meeting</option>
                            <option value="social">Social</option>
                            <option value="charity">Charity</option>
                            <option value="maintenance">Maintenance</option>
                        </select>
                    </div>
                    <button type="submit" class="admin-btn">Add Event</button>
                </form>
            </div>

            <!-- View Events Tab -->
            <div class="tab-content" id="viewEventsTab">
                <div class="admin-grid" id="eventsGrid">
                    <!-- Events will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Orders Section -->
        <div class="admin-section" id="ordersSection">
            <div class="section-header">
                <h2 class="section-title">Manage Orders</h2>
            </div>

            <div class="admin-tabs">
                <button class="tab-btn active" onclick="switchOrderTab('pending')">Pending Orders</button>
                <button class="tab-btn" onclick="switchOrderTab('completed')">Completed Orders</button>
            </div>

            <!-- Orders Tables -->
            <div class="tab-content active" id="pendingOrdersTab">
                <table class="orders-table">
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Customer</th>
                            <th>Items</th>
                            <th>Total</th>
                            <th>Date</th>
                            <th>Status</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="pendingOrdersBody">
                        <!-- Orders will be loaded here -->
                    </tbody>
                </table>
            </div>

            <div class="tab-content" id="completedOrdersTab">
                <table class="orders-table">
                    <thead>
                        <tr>
                            <th>Order ID</th>
                            <th>Customer</th>
                            <th>Items</th>
                            <th>Total</th>
                            <th>Date</th>
                            <th>Completed</th>
                        </tr>
                    </thead>
                    <tbody id="completedOrdersBody">
                        <!-- Orders will be loaded here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Export Section -->
        <div class="admin-section" id="exportSection">
            <div class="section-header">
                <h2 class="section-title">Export Data</h2>
            </div>

            <div class="form-group">
                <label>Date Range</label>
                <div style="display: flex; gap: 10px;">
                    <input type="date" class="admin-input" id="exportStartDate">
                    <span style="align-self: center;">to</span>
                    <input type="date" class="admin-input" id="exportEndDate">
                </div>
            </div>

            <div style="display: flex; gap: 10px; margin-top: 20px;">
                <button class="admin-btn" onclick="exportOrders('all')">Export All Orders</button>
                <button class="admin-btn secondary" onclick="exportOrders('pending')">Export Pending Orders</button>
                <button class="admin-btn secondary" onclick="exportOrders('completed')">Export Completed Orders</button>
            </div>
        </div>
    </div>

    <!-- Template Preview Modal -->
    <div class="template-preview-modal" id="templateModal">
        <div class="template-preview-content">
            <span class="close-modal" onclick="closeTemplateModal()">&times;</span>
            <div class="template-preview-header">
                <h2 style="color: var(--white); margin: 0;">Select Member Card Template</h2>
            </div>
            <div class="template-preview-grid" id="templateGrid">
                <!-- Templates will be inserted here -->
            </div>
            <div style="text-align: center;">
                <button class="admin-btn" onclick="saveTemplateSelection()">Save Template Selection</button>
                <button class="admin-btn secondary" onclick="closeTemplateModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Bulk Member Management Modal -->
    <div id="bulkMemberModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--norse-black); border: 2px solid var(--mc-red); padding: 30px; max-width: 800px; width: 90%; max-height: 90vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="color: var(--white); margin: 0;">Bulk Member Management</h2>
                <button onclick="closeBulkMemberModal()" style="background: none; border: none; color: var(--white); font-size: 24px; cursor: pointer;">&times;</button>
            </div>
            
            <div class="admin-form">
                <div class="form-group">
                    <label>Add Members by Email (one per line)</label>
                    <textarea id="bulkMemberEmails" class="admin-textarea" rows="10" placeholder="user1@example.com&#10;user2@example.com&#10;user3@example.com"></textarea>
                    <small style="color: #888;">Enter email addresses of users who should be members. Only existing users will be updated.</small>
                </div>
                
                <div class="form-group">
                    <label>Or Add Members by Email Domain</label>
                    <input type="text" id="memberDomain" class="admin-input" placeholder="@sleipnirmc.is">
                    <small style="color: #888;">All users with this email domain will be made members.</small>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="admin-btn" onclick="processBulkMembers()">Add Members</button>
                    <button class="admin-btn secondary" onclick="closeBulkMemberModal()">Cancel</button>
                </div>
                
                <div id="bulkMemberResults" style="margin-top: 20px; display: none;">
                    <h3 style="color: var(--white);">Results:</h3>
                    <div id="bulkMemberResultsContent"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Edit Product Modal -->
    <div id="editProductModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--norse-black); border: 2px solid var(--mc-red); padding: 30px; max-width: 800px; width: 90%; max-height: 90vh; overflow-y: auto;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 style="color: var(--white); margin: 0;">Edit Product</h2>
                <button onclick="closeEditModal()" style="background: none; border: none; color: var(--white); font-size: 24px; cursor: pointer;">&times;</button>
            </div>

            <form id="editProductForm" class="admin-form">
                <input type="hidden" id="editProductId">

                <div class="form-group">
                    <label>Product Name (Icelandic)</label>
                    <input type="text" class="admin-input" id="editProductNameIs" required>
                </div>

                <div class="form-group">
                    <label>Product Name (English)</label>
                    <input type="text" class="admin-input" id="editProductNameEn" required>
                </div>

                <div class="form-group">
                    <label>Description</label>
                    <textarea class="admin-textarea" id="editProductDescription" required></textarea>
                </div>

                <div class="form-group">
                    <label>Category</label>
                    <select class="admin-select" id="editProductCategory" required>
                        <option value="">Select Category</option>
                        <option value="tshirt">T-Shirt</option>
                        <option value="hoodie">Hoodie</option>
                        <option value="jacket">Jacket</option>
                        <option value="jeans">Jeans</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Price (ISK)</label>
                    <input type="number" class="admin-input" id="editProductPrice" required>
                </div>

                <div class="form-group">
                    <label>Available Sizes</label>
                    <div id="editSizesContainer" style="display: flex; gap: 10px; flex-wrap: wrap;"></div>
                </div>

                <div class="form-group">
                    <label>Members Only</label>
                    <select class="admin-select" id="editProductMembersOnly">
                        <option value="false">No</option>
                        <option value="true">Yes</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>Current Images</label>
                    <div id="editCurrentImages" style="display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 20px;"></div>
                </div>

                <div class="form-group">
                    <label>Add New Images</label>
                    <div class="drop-zone" id="editProductDropZone">
                        <p>Drag & drop images here or click to upload</p>
                        <input type="file" id="editProductImages" multiple accept="image/*" style="display: none;">
                    </div>
                    <div id="editImagePreview" style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px;"></div>
                </div>

                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button type="submit" class="admin-btn">Save Changes</button>
                    <button type="button" class="admin-btn secondary" onclick="closeEditModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-functions-compat.js"></script>
    <script src="javascript/firebase-config.js"></script>
    <script src="javascript/authentication.js"></script>
    <script src="javascript/language.js"></script>
    <script src="javascript/admin.js"></script>

    <script>
        // Authentication is handled by admin.js through protectAdminPage()
        let isAdminAuthenticated = false;
        
        // User Management Mode (false = Member Management, true = User Removal)
        let isUserRemovalMode = false;

        // Wait for auth state to be established by admin.js
        window.addEventListener('authStateChanged', (event) => {
            const { user, userDoc } = event.detail;
            if (user && userDoc && userDoc.role === 'admin') {
                isAdminAuthenticated = true;
                
                // Update UI
                const loadingOverlay = document.getElementById('loadingOverlay');
                if (loadingOverlay) {
                    loadingOverlay.style.display = 'none';
                }
                document.body.style.display = 'block';
                
                const userMenus = document.querySelectorAll('.user-menu');
                userMenus.forEach(menu => {
                    menu.style.display = 'flex';
                    const nameDisplay = menu.querySelector('.user-name');
                    if (nameDisplay) {
                        nameDisplay.textContent = userDoc.displayName || user.email;
                    }
                });
            }
        });

        // Additional page-specific initialization
        document.addEventListener('DOMContentLoaded', () => {
            // Add event listeners for user search and filter
            const userSearch = document.getElementById('userSearch');
            const userFilter = document.getElementById('userFilter');
            
            if (userSearch) {
                userSearch.addEventListener('input', debounce(() => {
                    if (document.getElementById('usersSection').classList.contains('active')) {
                        loadUsers();
                    }
                }, 300));
            }
            
            if (userFilter) {
                userFilter.addEventListener('change', () => {
                    if (document.getElementById('usersSection').classList.contains('active')) {
                        loadUsers();
                    }
                });
            }
        });
        
        // Debounce function for search input
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Toggle options dropdown
        function toggleOptions() {
            const options = document.getElementById('adminOptions');
            options.classList.toggle('active');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            const options = document.getElementById('adminOptions');
            if (!options.contains(e.target)) {
                options.classList.remove('active');
            }
        });

        // Show section
        function showSection(section) {
            // Verify admin is authenticated
            if (!isAdminAuthenticated) {
                window.location.href = 'login.html?redirect=admin';
                return;
            }

            // Hide all sections
            document.querySelectorAll('.admin-section').forEach(s => s.classList.remove('active'));

            // Show selected section
            document.getElementById(section + 'Section').classList.add('active');

            // Close dropdown
            document.getElementById('adminOptions').classList.remove('active');

            // Load section data
            switch(section) {
                case 'members':
                    loadMembers();
                    break;
                case 'users':
                    loadUsers();
                    break;
                case 'products':
                    loadProducts();
                    break;
                case 'events':
                    loadEvents();
                    break;
                case 'orders':
                    loadOrders();
                    break;
            }
        }

        // Switch tabs
        function switchTab(tab) {
            // Update tab buttons
            document.querySelectorAll('#productsSection .tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('#productsSection .tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tab + 'Tab').classList.add('active');
        }

        function switchEventTab(tab) {
            // Update tab buttons
            document.querySelectorAll('#eventsSection .tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('#eventsSection .tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tab + 'Tab').classList.add('active');
        }

        function switchOrderTab(status) {
            // Update tab buttons
            document.querySelectorAll('#ordersSection .tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');

            // Update tab content
            document.querySelectorAll('#ordersSection .tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(status + 'OrdersTab').classList.add('active');
        }

        // Load Members
        async function loadMembers() {
            const container = document.getElementById('membersContainer');
            container.innerHTML = '<p style="color: #888;">Loading members...</p>';

            try {
                const snapshot = await firebase.firestore().collection('displayMembers').get();
                container.innerHTML = '';

                if (snapshot.empty) {
                    container.innerHTML = '<p style="color: #888;">No members found.</p>';
                    return;
                }

                snapshot.forEach(doc => {
                    const member = doc.data();
                    const memberCard = document.createElement('div');
                    memberCard.className = 'member-card';
                    
                    // Format motorcycle type for display
                    let motorcycleType = 'Not specified';
                    if (member.motorcycleType) {
                        motorcycleType = member.motorcycleType;
                    } else if (member.motorcycle) {
                        const parts = [];
                        if (member.motorcycle.year) parts.push(member.motorcycle.year);
                        if (member.motorcycle.make) parts.push(member.motorcycle.make);
                        if (member.motorcycle.model) parts.push(member.motorcycle.model);
                        if (parts.length > 0) motorcycleType = parts.join(' ');
                    }
                    
                    memberCard.innerHTML = `
                        <img src="${member.photoUrl || member.photo || 'https://via.placeholder.com/60'}" alt="${member.name}" class="member-photo-small">
                        <div class="member-info">
                            <h3 style="margin: 0; color: var(--white);">${member.name}</h3>
                            <p style="margin: 5px 0; color: var(--gray);">${member.role || 'Member'}</p>
                            <p style="margin: 5px 0; color: var(--gray);">üèçÔ∏è ${motorcycleType}</p>
                            ${member.joinDate ? `<p style="margin: 0; font-size: 0.9rem; color: var(--gray);">Member since: ${new Date(member.joinDate.seconds * 1000).getFullYear()}</p>` : ''}
                            <p style="margin: 5px 0; color: var(--mc-red); font-size: 0.9rem;">Template: ${member.cardTemplate || 'classic'}</p>
                        </div>
                        <div class="member-actions">
                            <button class="admin-btn edit" onclick="editMember('${doc.id}')">Edit</button>
                            <button class="admin-btn secondary" onclick="selectTemplate('${doc.id}')">Template</button>
                        </div>
                    `;
                    container.appendChild(memberCard);
                });
            } catch (error) {
                console.error('Error loading members:', error);
                container.innerHTML = '<p style="color: #ff0000;">Error loading members. Please try again.</p>';
            }
        }

        // Load Users
        async function loadUsers() {
            const tbody = document.getElementById('usersTableBody');
            tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #888;">Loading users...</td></tr>';

            try {
                // Use authentication system to get all users
                const users = await sleipnirAuth.getAllUsers();
                tbody.innerHTML = '';

                if (users.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #888;">No users found.</td></tr>';
                    return;
                }

                // Apply filters
                const filter = document.getElementById('userFilter').value;
                const searchTerm = document.getElementById('userSearch').value.toLowerCase();
                
                let filteredUsers = [...users];
                
                if (filter === 'members') {
                    filteredUsers = filteredUsers.filter(u => u.members === true);
                } else if (filter === 'non-members') {
                    filteredUsers = filteredUsers.filter(u => u.members !== true);
                }
                
                if (searchTerm) {
                    filteredUsers = filteredUsers.filter(u => 
                        (u.displayName && u.displayName.toLowerCase().includes(searchTerm)) ||
                        (u.email && u.email.toLowerCase().includes(searchTerm))
                    );
                }

                filteredUsers.forEach(user => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td style="font-family: monospace; font-size: 12px;">${user.id.substring(0, 8)}...</td>
                        <td>${user.displayName || user.name || 'N/A'}</td>
                        <td>${user.email || 'N/A'}</td>
                        <td>${user.createdAt ? new Date(user.createdAt.toDate()).toLocaleDateString() : 'N/A'}</td>
                        <td>
                            ${user.members ? 
                                '<span style="color: #4CAF50; font-weight: bold;">‚úì Member</span>' : 
                                '<span style="color: #888;">Guest</span>'}
                            ${user.role === 'admin' ? ' <span style="color: var(--mc-red);">[Admin]</span>' : ''}
                        </td>
                        <td>${user.lastLogin ? new Date(user.lastLogin.toDate()).toLocaleDateString() : 'Never'}</td>
                        <td>
                            ${user.role !== 'admin' ? 
                                (isUserRemovalMode ?
                                    '<div class="delete-checkbox-wrapper">' +
                                        '<input type="checkbox" class="delete-user-checkbox" id="delete-' + user.id + '" data-user-id="' + user.id + '" data-user-email="' + user.email + '" onchange="handleDeleteCheckbox(this)">' +
                                        '<label for="delete-' + user.id + '" class="delete-checkbox-label">Delete</label>' +
                                    '</div>' :
                                    (user.members ?
                                        '<button class="admin-btn delete" onclick="toggleMemberStatus(\'' + user.id + '\', false)">Remove Member</button>' :
                                        '<button class="admin-btn secondary" onclick="toggleMemberStatus(\'' + user.id + '\', true)">Make Member</button>')
                                )
                                : '<span style="color: #888;">Admin User</span>'
                            }
                        </td>
                    `;
                    tbody.appendChild(row);
                });

                if (filteredUsers.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #888;">No users match the current filter.</td></tr>';
                }
            } catch (error) {
                console.error('Error loading users:', error);
                tbody.innerHTML = '<tr><td colspan="7" style="text-align: center; color: #ff0000;">Error loading users. Check admin permissions.</td></tr>';
            }
        }

        // Toggle User Management Mode
        function toggleUserManagementMode() {
            const checkbox = document.getElementById('userManagementMode');
            const modeLabel = document.getElementById('modeLabel');
            
            isUserRemovalMode = checkbox.checked;
            
            if (isUserRemovalMode) {
                modeLabel.textContent = 'User Removal Mode';
                modeLabel.style.color = '#f44336';
            } else {
                modeLabel.textContent = 'Member Management Mode';
                modeLabel.style.color = '#4CAF50';
            }
            
            // Reload users to update buttons
            loadUsers();
        }

        // Toggle Member Status
        async function toggleMemberStatus(userId, makeMember) {
            if (confirm(`Are you sure you want to ${makeMember ? 'make this user a member' : 'remove member status'}?`)) {
                try {
                    // Use authentication system to toggle membership
                    const result = await sleipnirAuth.toggleUserMembership(userId, makeMember);
                    
                    if (result.success) {
                        loadUsers(); // Reload the users table
                        sleipnirAuth.showAuthMessage({
                            is: `Me√∞limast√∂√∞u ${makeMember ? 'veitt' : 'fjarl√¶g√∞'} me√∞ g√≥√∞um √°rangri!`,
                            en: `Member status ${makeMember ? 'granted' : 'removed'} successfully!`
                        });
                    } else {
                        sleipnirAuth.showAuthMessage({
                            is: 'Villa vi√∞ a√∞ uppf√¶ra me√∞limast√∂√∞u',
                            en: 'Error updating member status'
                        }, true);
                    }
                } catch (error) {
                    console.error('Error updating member status:', error);
                    alert('Error updating member status. Please try again.');
                }
            }
        }

        // Old deleteUserAccount function removed - now using checkbox approach

        // Edit Member
        function editMember(memberId) {
            // TODO: Implement member editing modal
            alert('Member editing functionality will be implemented soon.');
        }

        // Member Search
        document.getElementById('memberSearch')?.addEventListener('input', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const memberCards = document.querySelectorAll('#membersContainer .member-card');

            memberCards.forEach(card => {
                const text = card.textContent.toLowerCase();
                card.style.display = text.includes(searchTerm) ? 'flex' : 'none';
            });
        });

        // Template Selection Functions
        let currentMemberId = null;
        let selectedTemplate = 'classic';

        async function selectTemplate(memberId) {
            currentMemberId = memberId;
            
            // Get member data
            try {
                const doc = await firebase.firestore().collection('displayMembers').doc(memberId).get();
                if (!doc.exists) {
                    alert('Member not found');
                    return;
                }
                
                const member = doc.data();
                selectedTemplate = member.cardTemplate || 'classic';
                
                // Show modal
                document.getElementById('templateModal').classList.add('active');
                
                // Populate template grid
                const templateGrid = document.getElementById('templateGrid');
                templateGrid.innerHTML = '';
                
                const templates = ['classic', 'horizontal', 'minimal', 'featured', 'badge'];
                const templateNames = {
                    classic: 'Classic Vertical',
                    horizontal: 'Horizontal Layout',
                    minimal: 'Minimal Design',
                    featured: 'Featured Display',
                    badge: 'Badge Style'
                };
                
                templates.forEach(templateName => {
                    const templateOption = document.createElement('div');
                    templateOption.className = 'template-option' + (templateName === selectedTemplate ? ' selected' : '');
                    templateOption.onclick = () => previewTemplate(templateName);
                    
                    templateOption.innerHTML = `
                        <h3 class="template-name">${templateNames[templateName]}</h3>
                        <div class="template-preview">
                            ${renderMemberCard({
                                ...member,
                                joinDate: member.joinDate || { seconds: Date.now() / 1000 },
                                motorcycleType: member.motorcycleType || 'Harley-Davidson'
                            }, templateName)}
                        </div>
                    `;
                    
                    templateGrid.appendChild(templateOption);
                });
                
            } catch (error) {
                console.error('Error loading member for template selection:', error);
                alert('Error loading member data');
            }
        }

        function previewTemplate(templateName) {
            selectedTemplate = templateName;
            
            // Update selection
            document.querySelectorAll('.template-option').forEach(option => {
                option.classList.remove('selected');
            });
            event.currentTarget.classList.add('selected');
        }

        function closeTemplateModal() {
            document.getElementById('templateModal').classList.remove('active');
            currentMemberId = null;
            selectedTemplate = 'classic';
        }

        async function saveTemplateSelection() {
            if (!currentMemberId) return;
            
            try {
                await firebase.firestore().collection('displayMembers').doc(currentMemberId).update({
                    cardTemplate: selectedTemplate
                });
                
                alert('Template updated successfully!');
                closeTemplateModal();
                loadMembers(); // Reload members to show updated template
                
            } catch (error) {
                console.error('Error saving template selection:', error);
                alert('Error saving template selection');
            }
        }

        // Show Bulk Member Management Modal
        function showBulkMemberModal() {
            document.getElementById('bulkMemberModal').style.display = 'block';
            document.getElementById('bulkMemberEmails').value = '';
            document.getElementById('memberDomain').value = '';
            document.getElementById('bulkMemberResults').style.display = 'none';
        }

        // Close Bulk Member Management Modal
        function closeBulkMemberModal() {
            document.getElementById('bulkMemberModal').style.display = 'none';
        }

        // Process Bulk Member Updates
        async function processBulkMembers() {
            const emailsText = document.getElementById('bulkMemberEmails').value.trim();
            const domain = document.getElementById('memberDomain').value.trim();
            
            if (!emailsText && !domain) {
                alert('Please provide either email addresses or a domain.');
                return;
            }
            
            const resultsDiv = document.getElementById('bulkMemberResults');
            const resultsContent = document.getElementById('bulkMemberResultsContent');
            resultsDiv.style.display = 'block';
            resultsContent.innerHTML = '<p style="color: #888;">Processing...</p>';
            
            try {
                // Get all users first
                const allUsers = await sleipnirAuth.getAllUsers();
                const results = {
                    updated: [],
                    notFound: [],
                    failed: [],
                    alreadyMembers: []
                };
                
                // Process email list
                if (emailsText) {
                    const emails = emailsText.split('\n')
                        .map(e => e.trim().toLowerCase())
                        .filter(e => e && e.includes('@'));
                    
                    for (const email of emails) {
                        const user = allUsers.find(u => u.email && u.email.toLowerCase() === email);
                        
                        if (!user) {
                            results.notFound.push(email);
                        } else if (user.members === true) {
                            results.alreadyMembers.push(email);
                        } else {
                            try {
                                const result = await sleipnirAuth.toggleUserMembership(user.id, true);
                                if (result.success) {
                                    results.updated.push(email);
                                } else {
                                    results.failed.push({ email, error: result.error });
                                }
                            } catch (error) {
                                results.failed.push({ email, error: error.message });
                            }
                        }
                    }
                }
                
                // Process domain
                if (domain) {
                    const domainLower = domain.toLowerCase();
                    const domainUsers = allUsers.filter(u => 
                        u.email && u.email.toLowerCase().endsWith(domainLower) && u.members !== true
                    );
                    
                    for (const user of domainUsers) {
                        try {
                            const result = await sleipnirAuth.toggleUserMembership(user.id, true);
                            if (result.success) {
                                results.updated.push(user.email);
                            } else {
                                results.failed.push({ email: user.email, error: result.error });
                            }
                        } catch (error) {
                            results.failed.push({ email: user.email, error: error.message });
                        }
                    }
                }
                
                // Display results
                let html = '';
                
                if (results.updated.length > 0) {
                    html += `<div style="color: #4CAF50; margin-bottom: 15px;">
                        <strong>‚úì Successfully made members (${results.updated.length}):</strong><br>
                        ${results.updated.join('<br>')}
                    </div>`;
                }
                
                if (results.alreadyMembers.length > 0) {
                    html += `<div style="color: #FF9800; margin-bottom: 15px;">
                        <strong>‚Ñπ Already members (${results.alreadyMembers.length}):</strong><br>
                        ${results.alreadyMembers.join('<br>')}
                    </div>`;
                }
                
                if (results.notFound.length > 0) {
                    html += `<div style="color: #F44336; margin-bottom: 15px;">
                        <strong>‚úó Users not found (${results.notFound.length}):</strong><br>
                        ${results.notFound.join('<br>')}
                    </div>`;
                }
                
                if (results.failed.length > 0) {
                    html += `<div style="color: #F44336; margin-bottom: 15px;">
                        <strong>‚úó Failed to update (${results.failed.length}):</strong><br>
                        ${results.failed.map(f => `${f.email}: ${f.error}`).join('<br>')}
                    </div>`;
                }
                
                resultsContent.innerHTML = html;
                
                // Reload users table if any updates were made
                if (results.updated.length > 0) {
                    loadUsers();
                    loadDashboardStats();
                }
                
            } catch (error) {
                console.error('Error processing bulk members:', error);
                resultsContent.innerHTML = `<p style="color: #F44336;">Error: ${error.message}</p>`;
            }
        }

        // Sync Real Members
        async function syncRealMembers() {
            const confirmMsg = `This will analyze the displayMembers collection (member profiles) and sync the member status 
for all users who have profiles there. This ensures real club members are recognized in the system.

Continue?`;
            
            if (!confirm(confirmMsg)) return;
            
            try {
                // Get displayMembers collection
                const displayMembersSnapshot = await firebase.firestore().collection('displayMembers').get();
                const memberUserIds = new Set();
                
                displayMembersSnapshot.forEach(doc => {
                    const data = doc.data();
                    if (data.userId) {
                        memberUserIds.add(data.userId);
                    }
                });
                
                if (memberUserIds.size === 0) {
                    alert('No member profiles found in displayMembers collection.');
                    return;
                }
                
                // Update each user's member status
                let updated = 0;
                let alreadyMembers = 0;
                let failed = 0;
                
                for (const userId of memberUserIds) {
                    try {
                        // Get user document
                        const userDoc = await firebase.firestore().collection('users').doc(userId).get();
                        
                        if (userDoc.exists) {
                            const userData = userDoc.data();
                            if (userData.members !== true) {
                                await firebase.firestore().collection('users').doc(userId).update({
                                    members: true,
                                    memberStatusSyncedAt: firebase.firestore.FieldValue.serverTimestamp(),
                                    memberStatusSyncReason: 'Synced from displayMembers collection'
                                });
                                updated++;
                            } else {
                                alreadyMembers++;
                            }
                        }
                    } catch (error) {
                        console.error(`Error updating user ${userId}:`, error);
                        failed++;
                    }
                }
                
                const message = `Real Members Sync Complete:
- Updated: ${updated} users
- Already members: ${alreadyMembers} users
- Failed: ${failed} users
- Total profiles: ${memberUserIds.size}`;
                
                alert(message);
                
                if (updated > 0) {
                    loadUsers();
                    loadDashboardStats();
                }
                
            } catch (error) {
                console.error('Error syncing real members:', error);
                alert('Error syncing members: ' + error.message);
            }
        }
        
        // Handle delete checkbox change
        function handleDeleteCheckbox(checkbox) {
            if (checkbox.checked) {
                const userId = checkbox.dataset.userId;
                const userEmail = checkbox.dataset.userEmail;
                
                // Create and show email confirmation modal
                showEmailConfirmationModal(userId, userEmail, checkbox);
            }
        }
        
        // Show email confirmation modal
        function showEmailConfirmationModal(userId, userEmail, checkbox) {
            // Remove any existing modal
            const existingModal = document.getElementById('emailConfirmModal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Create modal HTML
            const modalHtml = `
                <div class="modal-overlay" id="emailConfirmModal" onclick="closeEmailConfirmModal('${userId}')">
                    <div class="email-confirm-modal" onclick="event.stopPropagation()">
                        <h3>‚ö†Ô∏è Confirm User Deletion</h3>
                        <p>You are about to permanently delete the user:</p>
                        <p style="font-family: monospace; color: #fff; margin: 10px 0;">
                            <strong>Email:</strong> ${userEmail}<br>
                            <strong>ID:</strong> ${userId.substring(0, 8)}...
                        </p>
                        <div class="warning-text">
                            This action will:
                            <ul style="margin: 5px 0; padding-left: 20px;">
                                <li>Remove the user from Firebase Authentication</li>
                                <li>Delete their user profile</li>
                                <li>Archive their orders and data</li>
                            </ul>
                            <strong>This action CANNOT be undone!</strong>
                        </div>
                        <p style="margin-top: 20px;">To confirm deletion, please type the user's email address:</p>
                        <input type="email" id="emailConfirmInput" placeholder="Enter ${userEmail}" autocomplete="off">
                        <div style="display: flex; gap: 10px; margin-top: 20px;">
                            <button class="admin-btn delete" onclick="confirmUserDeletion('${userId}', '${userEmail}')">
                                Confirm Delete
                            </button>
                            <button class="admin-btn secondary" onclick="closeEmailConfirmModal('${userId}')">
                                Cancel
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            // Add modal to page
            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Focus on input
            setTimeout(() => {
                const input = document.getElementById('emailConfirmInput');
                if (input) input.focus();
            }, 100);
        }
        
        // Close email confirmation modal
        function closeEmailConfirmModal(userId) {
            const modal = document.getElementById('emailConfirmModal');
            if (modal) {
                modal.remove();
            }
            
            // Uncheck the checkbox
            const checkbox = document.getElementById('delete-' + userId);
            if (checkbox) {
                checkbox.checked = false;
            }
        }
        
        // Confirm user deletion
        async function confirmUserDeletion(userId, userEmail) {
            const emailInput = document.getElementById('emailConfirmInput');
            const enteredEmail = emailInput ? emailInput.value.trim() : '';
            
            if (enteredEmail !== userEmail) {
                sleipnirAuth.showAuthMessage({
                    is: 'Netfang passa√∞i ekki. H√¶tt vi√∞ ey√∞ingu.',
                    en: 'Email did not match. Deletion cancelled.'
                }, true);
                return;
            }
            
            try {
                // Show loading state
                const confirmBtn = document.querySelector('.email-confirm-modal .admin-btn.delete');
                if (confirmBtn) {
                    confirmBtn.disabled = true;
                    confirmBtn.textContent = 'Deleting...';
                }
                
                // Use the existing deleteUser method from sleipnirAuth
                const result = await sleipnirAuth.deleteUser(userId);
                
                if (result.success) {
                    closeEmailConfirmModal(userId);
                    loadUsers(); // Reload the users table
                    sleipnirAuth.showAuthMessage({
                        is: `Notandi ${userEmail} hefur veri√∞ fjarl√¶g√∞ur. ${result.ordersHandled} pantanir voru geymdar.`,
                        en: `User ${userEmail} has been deleted. ${result.ordersHandled} orders were archived.`
                    });
                    loadDashboardStats(); // Update stats
                } else {
                    sleipnirAuth.showAuthMessage({
                        is: 'Villa vi√∞ a√∞ ey√∞a notanda: ' + (result.error || '√ì√æekkt villa'),
                        en: 'Error deleting user: ' + (result.error || 'Unknown error')
                    }, true);
                }
            } catch (error) {
                console.error('Error deleting user:', error);
                sleipnirAuth.showAuthMessage({
                    is: 'Villa vi√∞ a√∞ ey√∞a notanda. Vinsamlegast reyndu aftur.',
                    en: 'Error deleting user. Please try again.'
                }, true);
            } finally {
                // Reset button state if modal still exists
                const confirmBtn = document.querySelector('.email-confirm-modal .admin-btn.delete');
                if (confirmBtn) {
                    confirmBtn.disabled = false;
                    confirmBtn.textContent = 'Confirm Delete';
                }
            }
        }
    </script>
</body>
</html>